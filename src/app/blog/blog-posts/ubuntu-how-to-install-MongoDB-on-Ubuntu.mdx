---
title: 'Как установить MongoDB на Ubuntu 22.04'
author: 'Роберт'
publishDate: '18.11.24'
group: 'ubuntu'
---

## Как установить MongoDB на Ubuntu 22.04

Чтобы установить актуальный пакет MongoDB, необходимо добавить его в список репозиториев.
Но предварительно следует импортировать открытый ключ для MongoDB в вашу систему.
Для этого используйте следующую команду:

```bash
curl -fsSL https://pgp.mongodb.com/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
```

Теперь добавьте репозиторий MongoDB 7.0 в директорию /etc/apt/sources.list.d:

```bash
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
```

В результате вы создадите файл с именем mongodb-org-7.0.list.
Для просмотра его содержимого можно использовать команду cat находясь в директории /etc/apt/sources.list.d/:

```bash
cd /etc/apt/sources.list.d/
cat mongodb-org-7.0.list
```

Затем обновите локальный список пакетов, в результате чего репозиторий MongoDB 7.0 будет добавлен в систему:

```bash
sudo apt update
```

Далее уже можно будет запустить установку непосредственно пакета MongoDB:

```bash
sudo apt install mongodb-org
```

По окончании установки следующей командой можно проверить версию установленного пакета:

```bash
mongod --version
```

![img1](https://ruvds.com/wp-content/uploads/2024/02/1-1.png)

При установке служба MongoDB по умолчанию будет отключена. Её включение производится при помощи системной утилиты systemctl:

```bash
sudo systemctl start mongod
```

Убедиться в том, что сервис работает, можно посмотрев его состояние:

```bash
sudo systemctl status mongod
```

![img1](https://ruvds.com/wp-content/uploads/2024/02/1-2.png)

Кроме того, вы можете проверить, прослушивает ли сервер соответствующий порт.
По умолчанию таким портом является порт 27017. Сделать это можно при помощи команды ss:

```bash
sudo ss -pnltu | grep 27017
```

![img1](https://ruvds.com/wp-content/uploads/2024/02/1-4.png)

После того, как вы убедились, что служба работает должным образом, при помощи следующей команды следует активировать её запуск при старте системы:

```bash
sudo systemctl enable mongod
```

Теперь ваш экземпляр MongoDB запущен и настроен для удаленного доступа. Чтобы подключиться к интерфейсу, используйте следующую команду:

```bash
mongosh
```

Далее, для использования установленной СУБД необходимо произвести настройки безопасности, заключающиеся в добавлении административной учётной записи и включении пользовательской аутентификации.

---

### Подключение к оболочке MongoDB

Для настройки будем использовать сервер, работающий под управлением Ubuntu 20.04. На сервере должен быть настроен брандмауэр при помощи UFW. Подключаться к серверу необходимо будет пользователем, имеющим привилегии sudo. Также, на сервере должен быть установлен пакет MongoDB версии 4.4 или выше.

Начиная с версии 3.0, служба MongoDB настроена только на приём подключений из локального Unix-сокета. При этом, аутентификация пользователей по умолчанию выключена, и любой пользователь, имеющий доступ к серверу, имеет доступ и к базе данных.

Первым шагом, для того, чтобы закрыть данную уязвимость, мы создадим административного пользователя. После чего, вы сможете включить пользовательскую аутентификацию и подключиться к базе данных под именем этой учётной записи, таким образом, получив доступ к ней.

Чтобы добавить административного пользователя, необходимо подключиться к оболочке Mongo. Так как пользовательская аутентификация отключена, вы можете сделать это используя команду **mongosh** без каких-либо параметров:

```bash
mongosh
```

Из-за того, что аутентификация всё ещё отключена, вывод выполнения команды будет содержать сообщения с предупреждением о том, что в Mongo не запущена система контроля доступа к базе данных, и доступ к чтению и записи данных и настроек базы не ограничен:

![img1](https://ruvds.com/wp-content/uploads/2021/05/1-1024x444.jpg)

Эти предупреждения исчезнут, когда вы включите аутентификацию. Пока же следует иметь ввиду, что пользователь, получающий доступ к вашей операционной системе, также получает контроль и над вашими базами данных.

Чтобы увидеть это, в оболочке Mongo запустите следующую команду:

```bash
show dbs
```

Эта команда возвращает список всех баз данных Mongo на сервере:

```bash
admin   0.000GB
config  0.000GB
local   0.000GB
```

Данный список должен выводится в зависимости от роли или уровня доступа к определённым базам, которые имеет пользователь Mongo, запускающий команду. Но поскольку аутентификация отключена, команда возвращает список всех баз данных без ограничений.
Сейчас в этом списке присутствуют только базы, созданные Mongo по умолчанию. Но, если в вашей системе будут находиться базы данных, содержащие какие-либо важные данные, любой пользователь сможет найти их при помощи данной команды.

### Добавление административного пользователя

Теперь, когда мы подключились к оболочке Mongo, давайте добавим в систему административного пользователя, в качестве первого шага на пути закрытия данной уязвимости. Для этого необходимо будет подключиться к базе данных admin.
В этой базе хранится информация об учётных записях Mongo, а именно, имена пользователей, их пароли и роли в системе:

```bash
> use admin
```

Вывод

```bash
switched to db admin
```

Чтобы создать нового пользователя с именем tom, запросом пароля passwordPrompt() и ролью с возможностью просматривать и редактировать данные в любых базах данных кластера, используя метод db.createUser():

```bash
> db.createUser({
    user: "tom",
    passwordPrompt(),
    roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ]
})
```

Появиться окно запроса пароля, где вводим новый пароль

```bash
Enter password:
```

Вывод будет такой:

```bash
Successfully added user: {
"user" : "tom",
"roles" : [
    {
        role: "userAdminAnyDatabase",
        db: "admin"
        },
        "readWriteAnyDatabase"
        }
]
```

Теперь можно выйти оболочки Mongo, для чего наберите команду exit.

```bash
exit
```

### Включение аутентификации

Чтобы запустить пользовательскую аутентификацию, необходимо внести изменения в конфигурационный файл MongoDB mongod.conf.
Пока вы не сделаете это и не перезапустите службу MongoDB, пользователи будут подключаться к вашим базам данным без аутентификации.
Однако, при этом они не смогут просматривать и редактировать данные пока не предоставят корректные имя пользователя и пароль.

Откройте для редактирования конфигурационный файл mongod.conf, например, при помощи текстового редактора nano:

```bash
cd /etc
sudo nano mongod.conf
```

В этом файле найдите строку **#security** и раскомментируйте её (удалите в начале строки символ #).

Следующей строкой добавьте текст:

```bash
authorization: enabled
```

Причём, необходимо убедиться, что в строке security нет никаких пробелов в её начале.
Строка же authorization: enabled, напротив, имеет два пробела отступа в начале строки.
Отредактированный текст должен выглядеть следующим образом:

![img1](https://ruvds.com/wp-content/uploads/2021/05/6.jpg)

После завершения редактирования сохраните изменения и закройте файл, для чего нажмите **Ctrl X**, затем **Y** и **Enter**.

Далее, необходимо перезапустить демон MongoDB для того, чтобы применились внесённые в конфигурацию изменения:

```bash
sudo systemctl restart mongod
```

Теперь запустите просмотр статуса службы:

```bash
sudo systemctl status mongod
```

Если перезапуск демона прошёл успешно, в выводе команды вы увидите, что служба mongod активна и находится в запущенном состоянии:

![img1](https://ruvds.com/wp-content/uploads/2021/05/7.jpg)

Теперь мы можем проверить, работает ли добавленный параметр аутентификации должным образом.

### Проверка параметров аутентификации

Теперь попробуем подключиться к оболочке Mongo.
Мы сделаем это для того, чтобы протестировать, как работает система пользовательской аутентификации, которая была запущена в предыдущем разделе:

```bash
mongosh
```

![img1](https://ruvds.com/wp-content/uploads/2021/05/10.jpg)

Как видите, при подключении к оболочке система больше не сообщает нам о том, что система контроля доступа к базам данных не запущена. Такие сообщения с предупреждениями вы могли видеть, когда подключались к оболочке в начале работ по настройке безопасности MongoDB. Из этого можно сделать вывод, что аутентификация включена.

Чтобы убедиться, что теперь доступ к базам ограничен, наберите:

```bash
show dbs
```

В отличие от того, как было раньше, когда эта команда возвращала список всех баз данных, теперь доступ к базам для вас закрыт, так как вы не авторизовались в Mongo как пользователь с каким-либо привилегиями.

И поскольку, какая-либо информация для вас теперь не доступна, мы можем заключить, что параметры аутентификации работают, как и ожидалось. Вы также не сможете создать пользователя или выполнить другие привилегированные задачи без авторизации в Mongo.

Теперь, отключитесь от оболочки, набрав exit, либо нажав Ctrl C.

Следующим шагом, необходимо убедиться, что ваш административный пользователь способен идентифицироваться должным образом с помощью запуска команды mongo для подключения от имени вашего пользователя.
Команда должна содержать флаг **-u**, после которого указывается имя пользователя, под которым будет происходить подключение к оболочке.
Не забудьте, что вместо **YourMongoAdmin** вам необходимо указать имя своего административного пользователя. Также, команда должна содержать флаг **-p**, который запросит у вас пароль вашего пользователя.
Плюс ко всему, флаг **-p** указывает **admin** в качестве базы данных проверки подлинности вашей учётной записи.

```bash
mongo -u YourMongoAdmin -p --authenticationDatabase admin
```

Теперь наберите пароль вашего пользователя и подключитесь к оболочке.

Ещё раз наберите команду show dbs.
Обратите внимание, что, поскольку ваша авторизация прошла успешно, вы снова можете видеть список всех баз данных Mongo:

```bash
show dbs
```

Вывод:

```bash
admin   0.000GB
config  0.000GB
local   0.000GB
```

Это подтверждает, что пользовательская аутентификация MongoDB запущена успешно.

---

### Настройка удаленного доступа к MongoDB

Откройте порт в брандмауэра UFW с определенного ip-адреса действующего приложения **your_other_server_ip**:

```bash
sudo ufw allow from your_other_server_ip/32 to any port 27017
```

Либо открыть порт для всех подключений:

```bash
sudo ufw allow 27017
```

Проверить статус открытых портов:

```bash
sudo ufw status
```

Теперь, несмотря на то, что порт по умолчанию открыт, сервер базы данных в настоящее время прослушивает 127.0.0.1.
Чтобы разрешить удаленные подключения, вы должны включить общедоступный IP-адрес вашего сервера в файл Mongo.conf.

```bash
sudo nano /etc/mongodb.conf
```

Найдите значение **bind_ip** и добавьте нужный IP-адрес:

```bash
...

logappend=true

bind_ip = 127.0.0.1,your_server_ip

#port = 27017

...
```

Вместо **your_server_ip** прописываем внешний (общедоступный) ip-адрес сервера, где развернуто MongoDB.
Запятая должна быть помещена перед добавлением IP-адреса, который вы хотите разрешить. Как только это будет сделано, сохраните изменения и выйдите из редактора.

Затем перезапустите MongoDB:

```bash
sudo systemctl restart mongodb
```

Протестировать можно с помощью MongoDB Compass, добавив новую **New Connection**, указав ip-адрес, и в разделе **Advanced Connection Options** -> **Authentication** указав логин пароль.
