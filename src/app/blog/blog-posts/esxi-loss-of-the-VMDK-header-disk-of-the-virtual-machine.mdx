---
title: 'Потеря заголовочного VMDK-диск виртуальной машины'
author: 'Роберт'
publishDate: '13.11.24'
group: 'esxi'
---

## Что делать, если пропал заголовочный VMDK-диск виртуальной машины VMware vSphere, но остался диск с данными (\*-flat.vmdk).

Как знают все администраторы VMware vSphere, виртуальный диск виртуальной машины представляется как минимум в виде двух файлов:

- **имя ВМ.vmdk** - заголовочный, он же индексный, он же файл-дескриптор виртуальго диска, который содержит информацию о геометрии диска, его тип и другие метаданные
- **`имя ВМ-flat.vmdk`** - непосредственно диск с данными ВМ

Практика показывает, что нередки ситуации, когда администраторы VMware vSphere теряют заголовочный файл VMDK по некоторым причинам, иногда необъяснимым, и остается только диск с данными ВМ (неудивительно, ведь в него идет запись, он залочен).

Ниже приведена краткая процедура по восстановлению дескрипторного VMDK-файла для существующего flat-VMDK, чтобы восстановить работоспособность виртуальной машины. Подробную инструкцию можно прочитать в [KB 1002511](http://kb.vmware.com/kb/1002511).

Итак, для тех, кто любит смотреть видеоинструкции:

[YouTube Видео](https://www.youtube.com/watch?v=FDdi5fvdeHw&t=41s)

Для тех, кто не любит:

1. Определяем точный размер в байтах VMDK-диска с данными (чтобы геометрия нового созданного дескриптора ему соответствовала):

```bash
ls -l <имя диска>-flat.vmdk
```

2. Создаем новый виртуальный диск (цифры - это полученный размер в байтах, тип thin для экономии места, lsilogic - контроллер):

```bash
vmkfstools -c 4294967296 -a lsilogic -d thin temp.vmdk
```

3. Переименовываем дескрипторный VMDK-файл созданного диска в тот файл, который нам нужен для исходного диска. Удаляем только что созданный пустой диск данных, который уже не нужен (temp-flat.vmdk).

4. Открываем переименованный дескрипторный файл VMDK и меняем выделенные ######### строчки:

```bash
# Disk DescriptorFile
version=1
CID=fb183c20
parentCID=ffffffff
createType="vmfs"

# Extent description
%RW 8388608 VMFS "vmdisk0-flat.vmdk"%

# The Disk Data Base
############DDB

ddb.virtualHWVersion = "4"
ddb.geometry.cylinders = "522"
ddb.geometry.heads = "255"
ddb.geometry.sectors = "63"
ddb.adapterType = "lsilogic"
##########ddb.thinProvisioned = "1"%
```

То есть, меняем просто имя flat VMDK-файла и убираем строчку о том, что диск thin provisioned, если он у вас изначально был flat.

Все - машину можно запускать.
